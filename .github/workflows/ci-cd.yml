name: CI-CD (Build -> Push -> Deploy to GKE)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ secrets.GCP_PROJECT }}
        service_account_key: ${{ secrets.GCP_SA_KEY_JSON }}

    - name: Configure Docker auth for Artifact Registry
      run: |
        # Write the service account JSON key safely
        cat > /tmp/gcloud-key.json <<'EOF'
        ${{ secrets.GCP_SA_KEY }}
        EOF

        # Authenticate with Google Cloud
        gcloud auth activate-service-account --key-file=/tmp/gcloud-key.json
        gcloud config set project ${{ secrets.GCP_PROJECT }}

        # Configure Docker authentication for Artifact Registry
        gcloud auth configure-docker --quiet ${{ secrets.GCP_REGION }}-docker.pkg.dev

    - name: Build Docker image
      run: |
        IMAGE="${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/backend-repo/backend:${{ github.sha }}"
        echo "IMAGE=$IMAGE" >> $GITHUB_ENV
        docker build -t $IMAGE .

    - name: Push Docker image
      run: docker push $IMAGE

    - name: Get GKE credentials
      run: |
        gcloud container clusters get-credentials primary-gke \
          --region=${{ secrets.GCP_REGION }} \
          --project=${{ secrets.GCP_PROJECT }}

    - name: Replace image placeholder and deploy
      run: |
        IMAGE="${{ env.IMAGE }}"
        sed -e "s|IMAGE_PLACEHOLDER|$IMAGE|g" k8s/deployment.yaml > k8s/deployment.generated.yaml
        kubectl apply -f k8s/deployment.generated.yaml
        kubectl apply -f k8s/service.yaml

    - name: Wait for service external-ip and print
      run: |
        echo "⏳ Waiting for GKE service to get external IP..."
        kubectl wait --for=condition=available --timeout=180s deployment/backend-deployment || true
        echo "✅ Deployed services:"
        kubectl get svc backend-service -o wide
